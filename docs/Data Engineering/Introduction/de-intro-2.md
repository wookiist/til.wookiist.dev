---
id: 'de-intro-2'
title: 'CH2 - 빅데이터의 탐색'
---
# 데이터베이스의 지연을 줄이기

데이터양이 증가함에 따라 집계에 걸리는 시간은 길어진다. 데이터 집계에 분 단위로 소요가 된다면 작업 효율은 그 이상으로 악화한다. 

초 단위로 데이터를 집계하려면 처음부터 그것에 맞게 시스템을 마련해야 한다. 

## 데이터 처리의 지연

가장 간단한 방법은 모든 데이터를 메모리에 올리는 것이다. 한 레코드의 크기가 500B이고 천만 개의 레코드가 있다고 가정하면 5GB가 된다. 이 정도라면 MySQL, PostgreSQL 등의 일반적인 RDB가 데이터 마트에 적합하다. 

RDB는 지연이 적고, 많은 수의 클라이언트가 동시 접속해도 성능이 나빠지지 않으므로 많은 사용자가 사용하는 실제 운영 환경의 데이터 마트로 특히 우수하다.
그러나 RDB는 메모리가 부족하면 성능이 급격히 저하된다. 수억 레코드를 초과하는 데이터 집계에서는 항상 **디바이스 I/O**가 발생한다고 가정하고 이것을 어떻게 효율화할 것인지가 중요하다.

## 압축과 분산에 의해 지연 줄이기

고속화를 위해 사용되는 기법이 '압축'과 '분산'이다. 데이터를 가능한 한 작게 압축하고 그것을 여러 디스크에 분산함으로써 데이터의 로드에 따른 지연을 줄인다.

분산된 데이터를 읽어 들이려면 **멀티 코어를 활용하면서 디스크 I/O를 병렬 처리하는 것이 효과적이다.** 이러한 아키텍처를 **MPP (Massive Parallel Processing, 대규모 병렬 처리)** 라고 한다. 대표적으로 Amazon Redshift와 Google BigQuery 등이 있다.

# 열 지향 데이터베이스 접근

칼럼을 압축하여 디스크 I/O를 줄인다.

빅데이터로 취급되는 데이터의 대부분은 디스크 상에 있다. 따라서 쿼리에 필요한 최소한의 데이터만을 가져옴으로써 지연을 줄일 수 있다. 이를 위해 **칼럼 단위로의 데이터 압축**을 한다. 

일반적인 DB는 레코드 단위의 읽고 쓰기에 최적화되어 있으며, 이를 행 지향 데이터베이스(row-oriented database)라고 한다. 

반면에 데이터 분석에 사용되는 DB는 **칼럼 단위의 집계에 최적화되어 있으며, 열 지향 데이터베이스(Column-Oriented Database) 또는 칼럼 지향 데이터베이스(Columnar Database)라고 한다.** 

처리량(throughput)은 일정 시간 안에 처리할 수 있는 데이터의 양을 의미한다. 처리량은 배치 처리 등의 대규모 데이터 처리에서 중요시된다. 
지연(delay)는 데이터 처리가 끝날 때까지의 대기 시간을 의미한다. 주로 애드 혹 데이터 분석 등에서 중요시된다. 
데이터 웨어하우스나 데이터 레이크는 대량의 데이터를 처리하기 위해 주로 **처리량을 중시**한다. 반면 데이터 마트에 요구되는 것은 **지연 시간의 단축**이다. 따라서 충분한 메모리를 준비하거나 디스크 I/O의 젊감이 필수적이다.

## 행 지향 데이터베이스

행 지향 데이터베이스에서는 테이블의 각 행을 하나의 덩어리로 디스크에 저장한다. 새 레코드를 추가할 때 파일의 끝에 데이터를 쓸 뿐이므로 빠르게 추가할 수 있다. 

행 지향 데이터베이스에서는 데이터 검색을 고속화하기 위해 인덱스를 만든다. 만일 인덱스가 없다면, 저장되는 모든 데이터를 로드해야 원하는 레코드를 찾을 수가 있으므로 많은 디스크 I/O가 발생하여 성능이 저하된다. 따라서 적절한 인덱스의 사용이 필수적이다.

그러나 데이터 분석에서는 어떤 칼럼이 사용될지 미리 알 수 없기 때문에 인덱스 작성이 거의 도움이 되지 않는다. **필연적으로 대량의 데이터 분석은 항상 디스크 I/O를 동반하므로, 인덱스에 의지하지 않는 고속화 기술이 필요하다.**

## **열 지향 데이터베이스**

예를 들어, 점포의 총 매출액을 알고 싶을 때는 고객 정보가 필요하지 않다. 행 지향 데이터베이스에서는 그러나, 레코드 단위로 데이터가 보관되므로 필요 없는 열까지도 디스크로 로드된다. 

한편, 열 지향 데이터베이스에서는 데이터를 미리 칼럼 단위로 정리해둠으로써 **필요한 칼럼만을 로드해 디스크 I/O를 줄인다.**

열 지향 데이터베이스는 **데이터 압축 효율도 우수하다.** 같은 칼럼에는 종종 유사한 데이터가 나열되므로, 같은 문자열의 반복은 매우 작게 압축할 수 있다.

# MPP 데이터베이스의 접근 방식

행 지향 데이터베이스에서 하나의 쿼리는 보통 하나의 스레드에서 실행된다. 많은 쿼리를 동시에 실행하여 여러 CPU 코어를 활용할 수 있지만, 이는 개별 쿼리가 분산 처리되는 것을 의미하진 않는다. 행 지향 데이터베이스에서 각 쿼리는 충분히 짧은 시간 안에 끝나는 것으로 생각하기 때문에 이를 분산 처리하는 것은 가정하지 않는 것이 일반적이다.

반면, 열 지향 데이터베이스에서는 디스크에서 대량의 데이터를 읽기 때문에 한번의 쿼리 실행 시간이 길어진다. 또한 압축된 데이터를 펼치는 등의 CPU 리소스도 소모하므로 멀티 코어를 활용해서 고속화하는 것이 좋다. 

MPP에서는 하나의 쿼리를 다수의 작은 태스크로 분해하고, 이를 가능한 한 병렬로 실행한다. 

예를 들어, 1억 레코드로 이루어진 테이블의 합계를 계산하기 위해 10만 레코드로 구분해서 1000개의 태스크로 분할하는 것이다.

## MPP 데이터베이스와 대화형 쿼리 엔진

쿼리가 잘 병렬화할 수 있다면, MPP를 활용한 데이터 집계는 CPU 코어 수에 비례하여 고속화된다. **단, 디스크로부터의 로드가 병목 현상이 발생하지 않도록 데이터가 고르게 분산되어 있어야 한다.** 

MPP는 구조상, 고속화를 위해 CPU와 디스크가 모두 균형 있게 늘려야 한다.

MPP의 아키텍처는 Hadoop과 함께 사용되는 대화형 쿼리 엔진으로도 채택되고 있다. 이 경우 데이터를 저장하는 것은 분산 스토리지의 역할이다. 그러나 데이터가 열 지향으로 압축되지 않는 한 MPP 데이터베이스와 동등한 성능은 되지 못한다. 따라서 Hadoop 상에서 열 지향 스토리지를 만들기 위해 여러 라이브러리가 개발되고 있다. 

열 지향 스토리지와 MPP에 의한 고속화를 할 때는 **리소스의 소비를 제한해야 한다.** 하나의 쿼리가 다수의 코어를 활용하면, 시스템의 모든 컴퓨트 리소스를 쉽게 소진한다는 뜻도 되며, 누군가 한 명이 실수로 거대한 쿼리를 실행하면 다른 모든 사용자가 그 영향을 받는다.